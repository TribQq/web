<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <title>try_try_2</title>

</head>

<body>
    <canvas id='screen' style='width: 640px; height: 640px;' />

    <script>
        function Scene(screen, controls) {
            this.canvas = screen.canvas;
            this.ctx = this.canvas.getContext('2d');
            this.controls = controls;
            this.imgs = screen.imgs;

        }


        function Lib(screen, controls) {
            Scene.apply(this, arguments);
            this.assets = [{
                name: 'tyan',
                path: 'assets/tyan.png'
            }, {
                name: 'player',
                path: 'assets/player.png'
            }, {
                name: 'sceleton',
                path: 'assets/sceleton.png'
            }, {
                name: 'bg',
                path: 'assets/tiles.png'
            }, {
                name: 'title',
                path: 'assets/title.jpg'
            }];

            this.total = this.assets.length;
            this.loaded = 0;
            this.status = "loading";


            this.loaded_at = 0;

            var self = this;
            for (var i = 0; i < this.total; i++) {
                var img = new Image();
                img.onload = function() {
                    self.loaded++;
                };
                img.src = self.assets[i].path;
                screen.imgs[self.assets[i].name] = img;

            }

        }

        Lib.prototype = Object.create(Scene.prototype);
        Lib.prototype.constructor = Lib;

        Lib.prototype.render = function(time) {
            if (this.status == "loading") {
                if (this.loaded == this.total) {
                    this.status = "loaded";
                    this.loaded_at = time;
                }
                this.ctx.fillStyle = '#000000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.fillStyle = '#ffffff';
                this.ctx.font = "22px Georgia";
                this.ctx.fillText("Loading " + this.loaded + '/' + this.total, 50, 70);
                return "lib";
            }

            if (this.status == "loaded") {
                if ((time - this.loaded_at) > 1000) {
                    return "menu";
                } else {
                    return "lib";
                }
            }

        }

        function Win(screen, controls) {
            Scene.apply(this, arguments);
        }

        Win.prototype = Object.create(Scene.prototype);
        Win.prototype.constructor = Win;


        Win.prototype.render = function(time) {
            this.ctx.fillStyle = '#000000';
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.fillStyle = '#ffffff';
            this.ctx.font = "22px Georgia";
            this.ctx.fillText("You won!Nice shot duDe!(￢_￢;)..", 50, 70);
            return "win";
        };

        function Menu(screen, controls) {
            Scene.apply(this, arguments);
        }

        Menu.prototype = Object.create(Scene.prototype);
        Menu.prototype.constructor = Menu;


        Menu.prototype.render = function(time) {

            this.ctx.drawImage(this.imgs['title'],
                0, 0, 640, 640,
                0, 0, 640, 640);

            this.ctx.fillStyle = '#FFFFFF';
            this.ctx.font = "22px Arial";
            this.ctx.fillText("Нажмите пробел", 250, 500);
            if (this.controls.states['fire']) {
                return "game";
            } else {
                return "menu";
            }
        };


        function Game(screen, controls) {
            Scene.apply(this, arguments);

            this.camera = new Camera(0, 0, this);
            this.player = new Player(100, -64, this);
            this.monster = new Player(896, 128, this);
            this.monster.type = "monster";
            this.monster.status = "walking";
            this.sounds = {};
            this.sounds['arrow'] = new Sound('assets/arrow.wav');
            this.sounds['sword'] = new Sound('assets/sword.wav');
            this.map = [
                [3, 20, 22, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2],
                [3, 20, 22, 3, 2, 4, 0, 4, 4, 3, 3, 4, 4, 4, 0, 4, 4, 4, 2, 3],
                [2, 29, 28, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 19, 3],
                [3, 27, 26, 24, 24, 27, 26, 24, 24, 27, 26, 24, 24, 27, 26, 24, 24, 27, 22, 3],
                [1, 20, 22, 4, 4, 20, 22, 4, 4, 20, 22, 4, 4, 20, 22, 4, 4, 20, 22, 3],
                [2, 20, 22, 0, 3, 20, 22, 4, 0, 20, 22, 2, 2, 20, 22, 2, 2, 20, 22, 3],
                [2, 20, 22, 0, 4, 20, 22, 0, 0, 20, 22, 4, 4, 20, 22, 4, 4, 20, 22, 3],
                [3, 20, 22, 0, 2, 20, 22, 0, 4, 20, 22, 0, 4, 20, 22, 2, 2, 20, 22, 3],
                [3, 20, 22, 0, 4, 20, 22, 0, 4, 20, 22, 4, 3, 20, 22, 4, 4, 20, 22, 3],
                [3, 20, 22, 0, 1, 20, 22, 4, 2, 20, 22, 4, 4, 20, 22, 0, 0, 20, 22, 3],
                [3, 20, 22, 0, 4, 20, 22, 4, 3, 20, 22, 0, 4, 20, 22, 4, 3, 20, 22, 3],
                [3, 20, 22, 0, 0, 20, 22, 3, 4, 20, 22, 4, 4, 20, 22, 4, 3, 20, 22, 3],
                [2, 20, 22, 0, 4, 20, 22, 2, 4, 20, 22, 0, 4, 20, 22, 4, 3, 20, 22, 3],
                [2, 20, 22, 0, 0, 20, 22, 4, 4, 20, 22, 4, 0, 20, 22, 0, 3, 20, 22, 3],
                [2, 20, 22, 0, 4, 20, 22, 2, 4, 20, 22, 4, 4, 20, 22, 2, 4, 20, 22, 3],
                [2, 20, 22, 0, 0, 20, 22, 2, 3, 20, 22, 0, 0, 20, 22, 3, 4, 20, 22, 3],
                [2, 20, 22, 0, 4, 20, 22, 4, 4, 20, 22, 0, 4, 20, 22, 4, 4, 20, 22, 3],
                [2, 20, 22, 0, 0, 20, 22, 4, 0, 20, 22, 0, 0, 20, 22, 0, 0, 20, 28, 18],
                [2, 20, 22, 0, 4, 20, 22, 0, 0, 20, 22, 4, 0, 20, 22, 0, 4, 23, 24, 24],
                [3, 1, 1, 3, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],



            ];
            this.tiles = [{
                    j: 0,
                    i: 0,
                    walk: true
                }, //0 - grass
                {
                    j: 1,
                    i: 0,
                    walk: false
                }, //1 - stone
                {
                    j: 2,
                    i: 0,
                    walk: true
                }, //2 - snowdrift
                {
                    j: 3,
                    i: 0,
                    walk: false
                }, //3 - tree
                {
                    j: 4,
                    i: 0,
                    walk: false
                }, //4 - house
                {
                    j: 5,
                    i: 0,
                    walk: false
                }, //5 - wall
                {
                    j: 6,
                    i: 0,
                    walk: false
                }, //6 - top wall
                {
                    j: 7,
                    i: 0,
                    walk: false
                }, //7 - top wall with r end
                {
                    j: 8,
                    i: 0,
                    walk: false
                }, //8 - top wall with l end
                {
                    j: 9,
                    i: 0,
                    walk: false
                }, //9 - wall with r end
                {
                    j: 5,
                    i: 1,
                    walk: false
                }, //10 - bottom-wall
                {
                    j: 6,
                    i: 1,
                    walk: false
                }, //11 - bottom-wall with r-end
                {
                    j: 7,
                    i: 1,
                    walk: false
                }, //12 - bottom-wall with l-end
                {
                    j: 8,
                    i: 1,
                    walk: false
                }, //13 - wall with l end
                {
                    j: 9,
                    i: 1,
                    walk: true
                }, //14 - top-grass with l-end
                {
                    j: 9,
                    i: 2,
                    walk: true
                }, //15 - top-grass with r-end
                {
                    j: 8,
                    i: 2,
                    walk: true
                }, //16 - stairs
                {
                    j: 0,
                    i: 1,
                    walk: true
                }, //17 - sand in grass b-r
                {
                    j: 1,
                    i: 1,
                    walk: true
                }, //18 - sand in grass b
                {
                    j: 2,
                    i: 1,
                    walk: true
                }, //19 - sand in grass b-l
                {
                    j: 0,
                    i: 2,
                    walk: true
                }, //20 - sand in grass r
                {
                    j: 1,
                    i: 2,
                    walk: true
                }, //21 - sand
                {
                    j: 2,
                    i: 2,
                    walk: true
                }, //22 - sand in grass l
                {
                    j: 0,
                    i: 3,
                    walk: true
                }, //23 - sand in grass u-r
                {
                    j: 1,
                    i: 3,
                    walk: true
                }, //24 - sand in grass u
                {
                    j: 2,
                    i: 3,
                    walk: true
                }, //25 - sand in grass u-l
                {
                    j: 3,
                    i: 1,
                    walk: true
                }, //26 - gras in sand b-r
                {
                    j: 4,
                    i: 1,
                    walk: true
                }, //27 - gras in sand b-l
                {
                    j: 3,
                    i: 2,
                    walk: true
                }, //28 - gras in sand u-r
                {
                    j: 4,
                    i: 2,
                    walk: true
                }, //29 - gras in sand u-l
            ];


            this.arrows = [];

        }
        Game.prototype = Object.create(Scene.prototype);

        Game.prototype.constructor = Game;

        Game.prototype.render_bg = function(time) {
            var start_col = Math.floor(this.camera.x / 64);
            var start_row = Math.floor(this.camera.y / 64);

            for (var i = start_row; i < (start_row + 11); i++) {
                for (var j = start_col; j < (start_col + 11); j++) {
                    if ((j < 20) && (i < 20)) {
                        var tile = this.tiles[this.map[i][j]];
                        this.ctx.drawImage(this.imgs['bg'],
                            tile.j * 64, tile.i * 64, 64, 64,
                            (j * 64) - this.camera.x, (i * 64) - this.camera.y, 64, 64);
                    }
                }
            }

        };


        Game.prototype.render_sprites = function(time) {


            this.player.update(time);
            this.monster.update(time);
            this.camera.update(time);


            //render monster
            this.ctx.drawImage(this.imgs['tyan'],
                this.monster.j * 64, this.monster.i * 64, 64, 64,
                (this.monster.x) - this.camera.x, (this.monster.y) - this.camera.y, 64, 64);

            //render player
            this.ctx.drawImage(this.imgs['player'],
                this.player.j * 64, this.player.i * 64, 64, 64,
                (this.player.x) - this.camera.x, (this.player.y) - this.camera.y, 64, 64);



            //render arows
            for (var i = this.arrows.length; i > 0; i--) {
                if (this.arrows[i - 1].active === false) this.arrows.splice(i - 1, 1);
            }

            for (var i = 0; i < this.arrows.length; i++) {
                this.arrows[i].update(time);
                this.ctx.drawImage(this.imgs['player'],
                    this.arrows[i].j * 64, this.arrows[i].i * 64, 64, 64,
                    (this.arrows[i].x) - this.camera.x, (this.arrows[i].y) - this.camera.y, 64, 64);

            }


        };
        Game.prototype.render = function(time) {
            this.ctx.fillStyle = '#ffffff';
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

            this.render_bg(time);
            this.render_sprites(time);

            if ((this.monster.dead) &&
                (this.player.x > 1152) &&
                (this.player.y > 1100)) {
                return "win";
            } else {
                return "game";
            }
        };


        function Camera(x, y, scene) {
            this.x = x;
            this.y = y;
            this.w = 640;
            this.h = 640;
            this.scene = scene;
        }
    </script>

</body>

</html>